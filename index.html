<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Ficha | Thrones of Westeros</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome 6 Pro -->
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/all.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/sharp-light.css">
    
    <!-- Chosen CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.min.css">
    
    <!-- Tippy.js -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    
    <style>
        /* Variables CSS (sin cambios) */
        :root {
            --ice-blue: #93c5fd;
            --frost-accent: #38bdf8;
            --deep-void: #050608;
            --slate-frost: #0f1217;
            --slate-ethereal: #1a1f26;
            --border-ice: rgba(147, 197, 253, 0.15);
            --white-5: rgba(255, 255, 255, 0.05);
            --white-10: rgba(255, 255, 255, 0.1);
            --white-20: rgba(255, 255, 255, 0.2);
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --virtud-color: #4ade80;
            --defecto-color: #f87171;
            --warning-color: #fbbf24;
            --bckg-op: rgba(15, 18, 23, 0.95);
            --border1: rgba(147, 197, 253, 0.2);
            --fblur: blur(8px);
            --title: #ffffff;
        }

        /* Reset y estilos base (sin cambios) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {width: 4px}::-webkit-scrollbar-track {background: #0F0F0F}::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.1); border-radius: 2px; -moz-border-radius: 2px}::-webkit-scrollbar-thumb:hover {background: var(--frost-accent)}

        body {
            background-color: #0a0c10; color: var(--slate-400); font-family: 'Montserrat', sans-serif; min-height: 100vh; line-height: 1.5;
        }

        @font-face {font-family:"Thrones of Westeros";
        src: url('https://static.tumblr.com/dr1ak2t/Wxuq86swy/gameofthrones-webfont.ttf')}
      
        ::selection {
            background-color: rgba(56, 189, 248, 0.3);
        }

        .cinzel {
            font-family: 'Cinzel', serif;
        }

        /* Glass panel effect */
        .glass-panel {
            background: #0F1216;
            border: 1px solid rgba(147, 197, 253, 0.1);
        }

        /* Main container */
        .main-container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
        }

        /* Title section */
        .title-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3rem;
        }

        .main-title {
            font-family: 'Thrones of Westeros', serif;
            font-size: 2.75rem;
            color: white;
            font-weight: 100;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.5), 0 0 40px rgba(56, 189, 248, 0.3);
        }

        .main-title span {
            color: var(--frost-accent);
        }

        /* Grid layout - dos columnas */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2.5rem;
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: 7fr 5fr;
            }
        }

        /* Form sections */
        .section {
            padding: 2em;
            margin-bottom: 2em;
        }

        .section-header {
            display: none;
        }

        .section-icon {
            display: none;
        }

        .section-title {
            display: none;
        }

        /* Form grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .form-grid .full-width {
                grid-column: span 3;
            }

            .form-grid .half-width {
                grid-column: span 1;
            }
        }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 0.625rem;
            color: var(--frost-accent);
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--white-10);
            color: white;
            font-size: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--frost-accent);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Estilo para los options de los selects nativos */
        select.form-select option {
            background-color: var(--slate-ethereal);
            color: white;
            padding: 0.5rem;
        }

        /* Estilo para el select cuando est√° abierto */
        select.form-select:focus {
            border-color: var(--frost-accent);
        }

        /* Puntos counter */
        .puntos-counter {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(15, 18, 23, 0.5) 100%);
            border: 1px solid var(--border-ice);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            border-radius: 0;
        }

        .puntos-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            color: var(--slate-500);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            white-space: nowrap;
        }

        .puntos-circulos {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .punto {
            font-size: 1.3rem;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .punto.virtud {
            color: var(--virtud-color);
            text-shadow: 0 0 8px rgba(74, 222, 128, 0.6);
            font-weight: 900;
        }

        .punto.defecto {
            color: var(--defecto-color);
            text-shadow: 0 0 8px rgba(248, 113, 113, 0.6);
            font-weight: 900;
        }

        .punto.disponible {
            color: var(--slate-600);
            opacity: 0.6;
            font-weight: 900;
        }

        .punto-neutral {
            color: var(--slate-600);
        }

        .puntos-info {
            font-size: 0.75rem;
            color: var(--slate-400);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
            white-space: nowrap;
            background: rgba(147, 197, 253, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 0;
            border: 1px solid rgba(147, 197, 253, 0.1);
        }

        .puntos-info i {
            color: var(--frost-accent);
            cursor: help;
            font-weight: 300;
            transition: all 0.3s;
        }

        .puntos-info i:hover {
            color: white;
            text-shadow: 0 0 8px rgba(56, 189, 248, 0.5);
        }

        .puntos-total {
            font-family: 'Cinzel', serif;
            color: var(--frost-accent);
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-contenido {
            background: var(--slate-ethereal);
            border: 1px solid var(--border-ice);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            color: var(--frost-accent);
            font-size: 1.5rem;
        }

        .modal-titulo {
            font-family: 'Cinzel', serif;
            font-size: 1.125rem;
            color: white;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .modal-texto {
            color: var(--slate-400);
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .modal-texto a {
            color: var(--frost-accent);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.3s;
        }

        .modal-texto a:hover {
            border-bottom-color: var(--frost-accent);
        }

        .modal-close {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            width: 100%;
        }

        .modal-close:hover {
            filter: brightness(1.1);
        }

        /* Tooltip personalizado */
        .tippy-box[data-theme~='principal'] {
            max-width: 300px;
            z-index: 99999 !important;
            background: var(--bckg-op);
            border: 1px solid var(--border1);
            font: 600 11px 'Cinzel';
            text-transform: uppercase;
            padding: 4px 8px;
            backdrop-filter: var(--fblur);
            border-radius: 0;
            pointer-events: none !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: var(--title);
        }

        .tippy-box[data-theme~='principal'] .tippy-content {
            padding: 8px 12px;
        }

        /* Estilos para Chosen - MEJORADOS */
        .chosen-container-multi .chosen-choices {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid var(--white-10) !important;
            border-radius: 0 !important;
            padding: 0.5rem !important;
            box-shadow: none !important;
        }

        .chosen-container-multi .chosen-choices li.search-field input[type=text] {
            color: rgba(255, 255, 255, 0.5) !important;
            font-family: 'Montserrat', sans-serif !important;
            font-size: 0.75rem !important;
            height: auto !important;
            padding: 0.25rem !important;
            margin: 0 !important;
        }

        .chosen-container-multi .chosen-choices li.search-choice {
            border-radius: 0 !important;
            color: white !important;
            font-family: 'Montserrat', sans-serif !important;
            font-size: 0.7rem !important;
            padding: 0.25rem 1.5rem 0.25rem 0.5rem !important;
            margin: 2px !important;
            line-height: 1.4 !important;
            border: 1px solid var(--white-10) !important;
            background: rgba(255, 255, 255, 0.1) !important;
            box-shadow: none !important;
        }
        
        /* Estilos para los Chosen de virtudes/defectos */
        .chosen-container-multi .chosen-choices li.search-choice.virtud-choice {
            background: rgba(74, 222, 128, 0.2) !important;
            border: 1px solid rgba(74, 222, 128, 0.3) !important;
            color: var(--virtud-color) !important;
        }
        
        .chosen-container-multi .chosen-choices li.search-choice.defecto-choice {
            background: rgba(248, 113, 113, 0.2) !important;
            border: 1px solid rgba(248, 113, 113, 0.3) !important;
            color: var(--defecto-color) !important;
        }

        .chosen-container-multi .chosen-choices li.search-choice .search-choice-close {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>') !important;
            background-size: contain !important;
            top: 0.35rem !important;
            right: 0.25rem !important;
        }

        .chosen-container .chosen-drop {
            background: var(--slate-ethereal) !important;
            border: 1px solid var(--border-ice) !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .chosen-container .chosen-results li {
            position: relative;  /* Para que el icono se posicione correctamente */
            color: var(--slate-400) !important;
            font-size: 0.75rem !important;
            padding: 0.5rem 0.5rem 0.5rem 2.5rem !important;  /* Espacio para el icono */
            line-height: 1.4 !important;
        }

        .chosen-container .chosen-results li.highlighted {
            background: rgba(56, 189, 248, 0.2) !important;
            color: white !important;
        }

        .chosen-container .chosen-results li.group-result {
            color: var(--frost-accent) !important;
            font-family: 'Cinzel', serif !important;
            font-size: 0.7rem !important;
            text-transform: uppercase !important;
            background: var(--slate-frost) !important;
            padding: 0.5rem !important;
        }

        /* Estilos para opciones deshabilitadas en Chosen */
        .chosen-container .chosen-results li.disabled-result {
            color: var(--slate-700) !important;
            cursor: not-allowed !important;
            opacity: 0.4 !important;
            background: rgba(248, 113, 113, 0.05) !important;
        }

        .chosen-container .chosen-results li.disabled-result::before {
            content: "\f05e";  /* Icono de c√≠rculo con exclamaci√≥n */
            font-family: "Font Awesome 6 Pro";
            position: absolute;
            left: 0.75rem;
            top: 0.35rem;
            color: var(--defecto-color);
            font-weight: 300;
            font-size: 0.9rem;
            opacity: 0.8;
            z-index: 2;
        }

        /* Estilos para los iconos de incompatibilidad */
        .incompatible-badge {
            display: inline-block;
            margin-left: 0.5rem;
            color: var(--defecto-color);
            cursor: help;
            font-size: 0.7rem;
        }

        /* Estilos para el Chosen de combate */
        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice {
            background: rgba(56, 189, 248, 0.15) !important;
            border: 1px solid rgba(56, 189, 248, 0.3) !important;
            color: var(--frost-accent) !important;
            padding-left: 2.2rem !important;
            position: relative;
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Arco y Flechas"]::before {
            content: "üèπ";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Armas Contundentes"]::before {
            content: "üî®";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Dagas"]::before {
            content: "üó°Ô∏è";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Escudos"]::before {
            content: "üõ°Ô∏è";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Espadas"]::before {
            content: "‚öîÔ∏è";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Hachas"]::before {
            content: "ü™ì";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice[data-option-value="Lanzas"]::before {
            content: "üî±";
        }

        .combate-chosen + .chosen-container-multi .chosen-choices li.search-choice::before {
            position: absolute;
            left: 0.5rem;
            font-size: 1rem;
        }

        /* Estilos para las opciones en el desplegable de combate */
        .combate-chosen + .chosen-container .chosen-results li {
            position: relative;
            padding-left: 1.5rem !important;
        }

        /* Metallic button */
        .metallic-button {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 900;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            padding: 1rem 2rem;
            border: 1px solid var(--white-10);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 100%;
            font-family: 'Montserrat', sans-serif;
        }

        .metallic-button:hover {
            filter: brightness(1.1);
        }

        .metallic-button i {
            transition: transform 0.3s;
            font-weight: 300;
        }

        .metallic-button:hover i {
            transform: translateX(0.25rem);
        }

        /* Code block */
        .code-block {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--white-5);
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--frost-accent);
            position: relative;
            background-image: radial-gradient(circle at 2px 2px, rgba(147, 197, 253, 0.05) 1px, transparent 0);
            background-size: 24px 24px;
            margin-bottom: 1rem;
            max-height: 500px;
            min-height: 200px;
            overflow-y: auto;
            width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .code-block code {
            display: block;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .code-title {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--slate-500);
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .code-copy-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: none;
            color: var(--frost-accent);
            font-size: 0.625rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-width: 140px;
            justify-content: flex-end;
        }

        .code-copy-button:hover {
            color: white;
        }

        .code-copy-button i {
            font-weight: 300;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .code-copy-button.copied {
            color: #4ade80;
        }

        .code-note {
            font-size: 0.5625rem;
            color: var(--slate-600);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.1em;
            line-height: 1.6;
        }
      
        .code-note a {
            color: var(--frost-accent);
            text-decoration: none;
            font-weight: 700;
            transition: all 0.3s ease;
            border-bottom: 1px solid transparent;
        }

        .code-note a:hover {
            color: white;
            border-bottom-color: var(--frost-accent);
        }

        /* Sticky sidebar */
        .sticky-sidebar {
            position: sticky;
            top: 100px;
        }

        /* Utility classes */
        .space-y-8 > * + * {
            margin-top: 2rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .w-full {
            width: 100%;
        }

        .text-white {
            color: white;
        }

        .text-frost-accent {
            color: var(--frost-accent);
        }

        /* Header Navigation */
        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(5, 6, 8, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-ice);
            margin-bottom: 3rem;
        }

        header nav {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        header nav span {
            display: flex;
            gap: 3rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        header nav a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--frost-accent);
            text-decoration: none;
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 0;
            position: relative;
        }

        header nav a:hover {
            color: white;
            border-bottom-color: var(--frost-accent);
            transform: translateY(-2px);
        }

        header nav a:hover::before {
            opacity: 1;
        }

        header nav a i {
            font-size: 0.9rem;
            font-weight: 300;
        }

        /* Secci√≥n descripci√≥n general */
        .descripcion-general {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.1) 0%, rgba(56, 189, 248, 0.05) 100%);
            border: 1px solid var(--border-ice);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 0;
        }

        .descripcion-general h3 {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--frost-accent);
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .descripcion-general h3 i {
            font-size: 1.1rem;
            font-weight: 300;
        }

        .descripcion-general p {
            color: var(--slate-400);
            font-size: 0.875rem;
            line-height: 1.7;
        }

        /* Formulario unificado */
        .formulario-unificado {
            background: var(--slate-ethereal);
            border: 1px solid var(--border-ice);
            padding: 2.5rem;
        }

        .formulario-bloque {
            margin-bottom: 2.5rem;
            padding-bottom: 2.5rem;
            border-bottom: 1px solid var(--border-ice);
        }

        .formulario-bloque:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .bloque-titulo {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--frost-accent);
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .bloque-titulo i {
            font-size: 1rem;
            font-weight: 300;
            color: var(--frost-accent);
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <nav>
            <span>
                <a href="https://thronesofwesterosrpg.forumcommunity.net/" target="_blank" rel="noopener noreferrer"><i class="fas fa-home"></i>Inicio</a>
                <a href="https://thronesofwesterosrpg.forumcommunity.net/?f=9158159" target="_blank" rel="noopener noreferrer"><i class="fas fa-book-open"></i>Sistemas de Juego</a>
                <a href="https://thronesofwesterosrpg.forumcommunity.net/?f=9158165" target="_blank" rel="noopener noreferrer"><i class="fas fa-pencil-alt"></i>Creaci√≥n de Ficha</a>
            </span>
        </nav>
    </header>

    <!-- Modal de informaci√≥n -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal-contenido">
            <div class="modal-header">
                <i class="fa-regular fa-circle-info modal-icon"></i>
                <h3 class="modal-titulo">Sistema de Rasgos</h3>
            </div>
            <div class="modal-texto">
                <p>En cuanto a las virtudes y defectos el jugador puede elegir cuantos quiera, siempre y cuando el balance de puntos sea 0 o positivo. El jugador comienza con 6 puntos de virtudes y defectos para gastar y puede ganar m√°s puntos adquiriendo defectos.</p>
                <br>
                <p>Para m√°s informaci√≥n visitar el <a href="https://thronesofwesterosrpg.forumcommunity.net/?t=63430733" target="_blank" rel="noopener noreferrer">Sistema de Rasgos</a>.</p>
            </div>
            <button class="modal-close" onclick="cerrarModal()">Entendido</button>
        </div>
    </div>

    <div class="main-container">
        <div class="title-section">
            <div>
                <h2 class="main-title">Generador de Ficha</h2>
            </div>
        </div>

        <!-- Descripci√≥n general del generador -->
        <div class="descripcion-general">
            <h3><i class="fas fa-info-circle"></i>¬øC√≥mo funciona?</h3>
            <p>Este generador de fichas te ayuda a crear un registro completo de tu personaje en <strong>Thrones of Westeros RPG</strong>. Completa los campos con la informaci√≥n de tu personaje, selecciona tus rasgos (virtudes y defectos) respetando el balance de puntos, y el sistema generar√° autom√°ticamente el c√≥digo formateado para publicar tu ficha en el foro. Recuerda que el equilibrio de puntos debe ser 0 o positivo: comienzas con 6 puntos para gastar en virtudes, pero puedes obtener m√°s puntos seleccionando defectos.</p>
        </div>

        <div class="grid">
            <!-- Columna izquierda: Generador -->
            <div class="space-y-8">
                <form method="POST" action="#" name="formu" class="formu">
                    <section class="glass-panel section">
                        <div class="section-header">
                            <i class="fa-regular fa-image section-icon"></i>
                            <h3 class="section-title">Imagen del Personaje</h3>
                        </div>
                        <div class="form-grid">
                            <div class="full-width">
                                <label class="form-label">Enlace de la imagen de tu personaje:</label>
                                <input type="text" name="img" class="form-input" placeholder="https://imgur.com/...">
                            </div>
                        </div>
                    </section>

                    <section class="glass-panel section">
                        <div class="section-header">
                            <i class="fa-regular fa-pen section-icon"></i>
                            <h3 class="section-title">I. Registro de Linaje</h3>
                        </div>
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Nombre OOC:</label>
                                <input type="text" name="occ" class="form-input" placeholder="Tu Nick">
                            </div>
                            <div>
                                <label class="form-label">Nombre IC:</label>
                                <input type="text" name="ic" class="form-input" placeholder="Ej. Jon Snow">
                            </div>
                            <div>
                                <label class="form-label">Edad:</label>
                                <input type="text" name="edad" class="form-input" placeholder="25">
                            </div>
                            <div>
                                <label class="form-label">G√©nero:</label>
                                <input type="text" name="genero" class="form-input" placeholder="Masculino">
                            </div>
                            <div>
                                <label class="form-label">Lugar de Origen:</label>
                                <input type="text" name="origen" class="form-input" placeholder="El Norte">
                            </div>
                            <div>
                                <label class="form-label">Oficio:</label>
                                <input type="text" name="oficio" class="form-input" placeholder="Guerrero">
                            </div>
                            <div>
                                <label class="form-label">Estado civil:</label>
                                <input type="text" name="estadocivil" class="form-input" placeholder="Soltero">
                            </div>
                            <div>
                                <label class="form-label">Afiliaci√≥n (Casa/Facci√≥n):</label>
                                <input type="text" name="afi" class="form-input" placeholder="Casa Stark">
                            </div>
                        </div>
                    </section>

                    <section class="glass-panel section">
                        <div class="section-header">
                            <i class="fa-regular fa-medal section-icon"></i>
                            <h3 class="section-title">II. Rasgos del Personaje</h3>
                        </div>
                        <div class="form-grid">
                            <div class="full-width">
                                <label class="form-label">Ascendencia:</label>
                                <select name="ascendencia" class="form-select">
                                    <option hidden selected disabled value=""></option>
                                    <option value="Descendiente de los Primeros Hombres">Descendiente de los Primeros Hombres</option>
                                    <option value="Descendiente de los √Åndalos">Descendiente de los √Åndalos</option>
                                    <option value="Descendiente de los Rhoynar">Descendiente de los Rhoynar</option>
                                    <option value="Valyrio">Valyrio</option>
                                    <option value="Ascendencia √önica">Ascendencia √önica</option>
                                </select>
                            </div>
                            <div class="full-width">
                                <label class="form-label">Religi√≥n:</label>
                                <select name="religion" class="form-select">
                                    <option hidden selected disabled value=""></option>
                                    <option value="Fe de los Siete">Fe de los Siete</option>
                                    <option value="Dioses Antiguos">Dioses Antiguos</option>
                                    <option value="Dios Ahogado">Dios Ahogado</option>
                                    <option value="R'hllor">R'hllor</option>
                                    <option value="Muchos Rostros">Muchos Rostros</option>
                                    <option value="Cabra Negra">Cabra Negra</option>
                                </select>
                            </div>
                            <div class="full-width">
                                <label class="form-label">Constituci√≥n:</label>
                                <select name="constitucion" class="form-select" onchange="actualizarAtributos()">
                                    <option hidden selected disabled value=""></option>
                                    <option value="Fuerte">Fuerte</option>
                                    <option value="Robusto">Robusto</option>
                                    <option value="Atl√©tico">Atl√©tico</option>
                                    <option value="√Ågil">√Ågil</option>
                                    <option value="Resistente">Resistente</option>
                                </select>
                            </div>
                            <div class="full-width">
                                <label class="form-label">Virtudes y defectos (selecci√≥n m√∫ltiple):</label>
                                
                                <!-- Puntos counter -->
                                <div class="puntos-counter">
                                    <span class="puntos-titulo">Ranuras disponibles:</span>
                                    <div class="puntos-circulos" id="puntosCirculos">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                    <div class="puntos-info">
                                        <i class="fa-regular fa-circle-info" onclick="abrirModal()" style="cursor: pointer;"></i>
                                        <span id="puntosBalance">0</span> / <span id="puntosTotal">6</span>
                                    </div>
                                </div>

                                <select id="dropdown" name="rasgos" class="multipleChosen" multiple="true">
                                    <optgroup label="Virtudes">
                                        <option value="Bello" data-tipo="virtud" data-puntos="-3" data-incompatible="Feo" data-efecto="Concede +2 Carisma y +1 Persuasi√≥n.">Bello (-3)</option>
                                        <option value="Bondadoso" data-tipo="virtud" data-puntos="-2" data-incompatible="Ap√°tico,S√°dico" data-efecto="Concede +2 Carisma.">Bondadoso (-2)</option>
                                        <option value="Honorable" data-tipo="virtud" data-puntos="-1" data-incompatible="Manipulador,S√°dico" data-efecto="Concede +2 Carisma.">Honorable (-1)</option>
                                        <option value="Astuto" data-tipo="virtud" data-puntos="-3" data-incompatible="Tonto" data-efecto="Aumenta la Persuasi√≥n en +2 y la Sabidur√≠a en +1.">Astuto (-3)</option>
                                        <option value="L√≠der" data-tipo="virtud" data-puntos="-3" data-incompatible="" data-efecto="Concede +1 Liderazgo.">L√≠der (-3)</option>
                                        <option value="Seductor" data-tipo="virtud" data-puntos="-3" data-incompatible="Desagradable" data-efecto="Concede +3 Persuasi√≥n.">Seductor (-3)</option>
                                        <option value="Intrigante" data-tipo="virtud" data-puntos="-3" data-incompatible="Honorable" data-efecto="Concede +4 Persuasi√≥n.">Intrigante (-3)</option>
                                        <option value="Inteligente" data-tipo="virtud" data-puntos="-4" data-incompatible="Tonto" data-efecto="Aumenta la Sabidur√≠a en +2.">Inteligente (-4)</option>
                                        <option value="Protector" data-tipo="virtud" data-puntos="-2" data-incompatible="Ap√°tico" data-efecto="Concede +1 Liderazgo.">Protector (-2)</option>
                                        <option value="Valiente" data-tipo="virtud" data-puntos="-3" data-incompatible="Cobarde" data-efecto="Resistencia a efectos de miedo.">Valiente (-3)</option>
                                        <option value="Sabio" data-tipo="virtud" data-puntos="-3" data-incompatible="Tonto,Vago" data-efecto="Aumenta +4 Sabidur√≠a.">Sabio (-3)</option>
                                        <option value="S√°dico" data-tipo="virtud" data-puntos="-3" data-incompatible="Honorable,Emp√°tico" data-efecto="Concede +2 en combate contra enemigos heridos.">S√°dico (-3)</option>
                                        <option value="Corpulento" data-tipo="virtud" data-puntos="-2" data-incompatible="√Ågil,Endeble" data-efecto="Aumenta la Vitalidad en un 10%.">Corpulento (-2)</option>
                                        <option value="Diplom√°tico" data-tipo="virtud" data-puntos="-3" data-incompatible="Ap√°tico" data-efecto="Otorga +4 Carisma.">Diplom√°tico (-3)</option>
                                    </optgroup>
                                    <optgroup label="Defectos">
                                        <option value="Gordo" data-tipo="defecto" data-puntos="+3" data-incompatible="Atl√©tico,√Ågil" data-efecto="Reduce la Velocidad base en un 20% [x0.80].">Gordo (+3)</option>
                                        <option value="Endeble" data-tipo="defecto" data-puntos="+4" data-incompatible="Robusto,Fuerte,Corpulento" data-efecto="Reduce la Fuerza base en un 20% [x0.80].">Endeble (+4)</option>
                                        <option value="Manco" data-tipo="defecto" data-puntos="+4" data-incompatible="" data-efecto="Reduce la Fuerza base en un 40% [x0.60].">Manco (+4)</option>
                                        <option value="Cojo" data-tipo="defecto" data-puntos="+4" data-incompatible="" data-efecto="Reduce la Velocidad base en un 40% [x0.60].">Cojo (+4)</option>
                                        <option value="Feo" data-tipo="defecto" data-puntos="+3" data-incompatible="Bello,Seductor" data-efecto="Reduce el Carisma en -2 y la Persuasi√≥n en -2.">Feo (+3)</option>
                                        <option value="Inf√©rtil" data-tipo="defecto" data-puntos="+2" data-incompatible="" data-efecto="No puedes tener hijos.">Inf√©rtil (+2)</option>
                                        <option value="Marcado" data-tipo="defecto" data-puntos="+2" data-incompatible="" data-efecto="Reduce la Vitalidad base en 10% [x0.90].">Marcado (+2)</option>
                                        <option value="Tuerto" data-tipo="defecto" data-puntos="+1" data-incompatible="" data-efecto="-1 a ataques a distancia.">Tuerto (+1)</option>
                                        <option value="Ap√°tico" data-tipo="defecto" data-puntos="+1" data-incompatible="Bondadoso" data-efecto="Reduce -2 Carisma.">Ap√°tico (+1)</option>
                                        <option value="Atormentado" data-tipo="defecto" data-puntos="+2" data-incompatible="" data-efecto="Reduce el Carisma en -2.">Atormentado (+2)</option>
                                        <option value="Cobarde" data-tipo="defecto" data-puntos="+2" data-incompatible="Valiente" data-efecto="Penalizaci√≥n en situaciones de peligro.">Cobarde (+2)</option>
                                        <option value="Enano" data-tipo="defecto" data-puntos="+4" data-incompatible="" data-efecto="Reduce Fuerza 25%, Vitalidad y Velocidad 20%.">Enano (+4)</option>
                                        <option value="Tonto" data-tipo="defecto" data-puntos="+3" data-incompatible="Inteligente,Sabio" data-efecto="Reduce -4 la Sabidur√≠a.">Tonto (+3)</option>
                                        <option value="Ciego" data-tipo="defecto" data-puntos="+4" data-incompatible="" data-efecto="No puedes elegir un estilo de combate.">Ciego (+4)</option>
                                        <option value="Perezoso" data-tipo="defecto" data-puntos="+1" data-incompatible="" data-efecto="Dificultad para iniciar acciones.">Perezoso (+1)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </section>

                    <section class="glass-panel section">
                        <div class="section-header">
                            <i class="fa-regular fa-compass section-icon"></i>
                            <h3 class="section-title">III. Informaci√≥n Adicional</h3>
                        </div>
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Ubicaci√≥n actual:</label>
                                <input type="text" name="ubicacion" class="form-input" placeholder="Invernalia">
                            </div>
                            <div>
                                <label class="form-label">Asentamiento:</label>
                                <input type="text" name="asentamiento" class="form-input" placeholder="Invernalia">
                            </div>
                            <div>
                                <label class="form-label">Regi√≥n:</label>
                                <input type="text" name="region" class="form-input" placeholder="El Norte">
                            </div>
                            <div>
                                <label class="form-label">Orientaci√≥n sexual:</label>
                                <input type="text" name="orientacion" class="form-input" placeholder="Heterosexual">
                            </div>
                            <div class="full-width">
                                <label class="form-label">Lema / Cita / T√≠tulo honor√≠fico:</label>
                                <input type="text" name="lema" class="form-input" placeholder='"Se acerca el invierno"'>
                            </div>
                            <div class="full-width">
                                <label class="form-label">Estilo de combate (m√°ximo 2):</label>
                                <select name="estilo_combate" class="combate-chosen" multiple="true">
                                    <option value="Arco y Flechas" title="Ataques a distancia precisos">Arco y Flechas</option>
                                    <option value="Armas Contundentes" title="Fuerza bruta y impacto">Armas Contundentes</option>
                                    <option value="Dagas" title="Ataques r√°pidos y √°giles">Dagas</option>
                                    <option value="Escudos" title="Maestr√≠a en defensa">Escudos</option>
                                    <option value="Espadas" title="Equilibrio y precisi√≥n">Espadas</option>
                                    <option value="Hachas" title="Poder y alcance">Hachas</option>
                                    <option value="Lanzas" title="Versatilidad ofensiva">Lanzas</option>
                                </select>
                                <div id="combateError" style="color: var(--defecto-color); font-size: 0.7rem; margin-top: 0.5rem; display: none;">
                                    <i class="fa-regular fa-circle-exclamation"></i>
                                    <span id="combateErrorText">Solo puedes seleccionar un m√°ximo de 2 estilos de combate.</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Bot√≥n -->
                    <div class="pt-4">
                        <button type="button" class="metallic-button" onclick="generar()">
                            <span>Generar C√≥digo IC</span>
                            <i class="fa-regular fa-bolt"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Columna derecha: C√≥digo -->
            <div class="sticky-sidebar space-y-8">
                <div class="space-y-4">
                    <div class="code-header">
                        <h3 class="code-title">Pergamino de C√≥digo</h3>
                        <button class="code-copy-button" onclick="copiarCodigo()" id="copyButton">
                            <i class="fa-regular fa-copy"></i>
                            <span>Copiar C√≥digo</span>
                        </button>
                    </div>
                    <div class="code-block">
                        <code id="code" class="block leading-loose whitespace-pre-wrap"></code>
                    </div>
                    <p class="code-note">
                        Copia el siguiente c√≥digo y s√∫belo como un nuevo tema en el foro de <a href="https://thronesofwesterosrpg.forumcommunity.net/?f=9158165" target="_blank" rel="noopener noreferrer">fichas</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <link rel="stylesheet" href="https://cdn.forumfree.net/libs/tippyjs/css/theme+animation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.jquery.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://cdn.forumfree.net/libs/tippyjs/tippy.js"></script>
    
    <script>
        // Configurar Tippy.js con soporte para title attributes
        function withTitleAttributeContent(tippy) {
            return (targets, options = {}) => tippy(targets, {
                ...options,
                content(reference) {
                    if (options.content) {
                        return options.content
                    }
                    const title = reference.getAttribute('title')
                    reference.removeAttribute('title')
                    return title
                }
            })
        }
        
        // window.tippy = withTitleAttributeContent(tippy)
    </script>
    
    <script>
        // Variables globales
        const BASE_VIT = 450;
        const BASE_EN = 150;
        const BASE_FUE = 15;
        const BASE_VEL = 3;
        const PUNTOS_INICIALES = 6;

        const multiplicadores = {
            'Fuerte': { vit: 1, en: 1, fue: 1.30, vel: 1 },
            'Robusto': { vit: 1.30, en: 1, fue: 1, vel: 1 },
            'Atl√©tico': { vit: 1.15, en: 1, fue: 1.15, vel: 1 },
            '√Ågil': { vit: 1.15, en: 1, fue: 1.15, vel: 1 },
            'Resistente': { vit: 1, en: 1.20, fue: 1, vel: 1 }
        };

        let puntosDisponibles = 0;
        let puntosTotales = PUNTOS_INICIALES;
        let rasgosSeleccionados = [];

        // Mapa de incompatibilidades
        const incompatibilidades = {
            'Bello': ['Feo'],
            'Bondadoso': ['Ap√°tico', 'S√°dico'],
            'Honorable': ['Manipulador', 'S√°dico'],
            'Astuto': ['Tonto'],
            'Seductor': ['Desagradable'],
            'Intrigante': ['Honorable'],
            'Inteligente': ['Tonto'],
            'Protector': ['Ap√°tico'],
            'Valiente': ['Cobarde'],
            'Sabio': ['Tonto', 'Vago'],
            'S√°dico': ['Honorable', 'Emp√°tico'],
            'Corpulento': ['√Ågil', 'Endeble'],
            'Diplom√°tico': ['Ap√°tico'],
            'Gordo': ['Atl√©tico', '√Ågil'],
            'Endeble': ['Robusto', 'Fuerte', 'Corpulento'],
            'Feo': ['Bello', 'Seductor'],
            'Ap√°tico': ['Bondadoso'],
            'Cobarde': ['Valiente'],
            'Tonto': ['Inteligente', 'Sabio'],
            'Ciego': ['Estilo de Combate']
        };

        // Lista de estilos de combate
        const estilosCombate = ['Arco y Flechas', 'Armas Contundentes', 'Dagas', 'Escudos', 'Espadas', 'Hachas', 'Lanzas'];

        // Funci√≥n para abrir modal
        function abrirModal() {
            document.getElementById('infoModal').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Actualizar c√≠rculos de puntos (ranuras)
        function actualizarPuntosCirculos() {
            const contenedor = document.getElementById('puntosCirculos');
            const balanceSpan = document.getElementById('puntosBalance');
            const totalSpan = document.getElementById('puntosTotal');
            
            // Calcular puntos gastados en virtudes
            const puntosVirtudes = rasgosSeleccionados
                .filter(r => r.tipo === 'virtud')
                .reduce((total, r) => total + Math.abs(parseInt(r.puntos)), 0);
            
            // Calcular puntos ganados por defectos
            const puntosDefectos = rasgosSeleccionados
                .filter(r => r.tipo === 'defecto')
                .reduce((total, r) => total + parseInt(r.puntos), 0);
            
            // Total de ranuras disponibles
            puntosTotales = PUNTOS_INICIALES + puntosDefectos;
            
            // Ranuras disponibles = total - virtudes gastadas
            puntosDisponibles = puntosTotales - puntosVirtudes;
            
            balanceSpan.textContent = puntosDisponibles;
            totalSpan.textContent = puntosTotales;
            
            let html = '';
            
            // Mostrar ranuras totales
            for (let i = 0; i < puntosTotales; i++) {
                if (i < puntosVirtudes) {
                    // Ranuras ocupadas por virtudes
                    html += '<span class="punto virtud">‚óè</span>';
                } else {
                    // Ranuras disponibles
                    html += '<span class="punto disponible">‚óè</span>';
                }
            }
            
            contenedor.innerHTML = html;
        }

        // Obtener lista de incompatibilidades como texto
        function getIncompatibilidadesTexto(valor) {
            if (incompatibilidades[valor] && incompatibilidades[valor].length > 0) {
                return 'Incompatible con: ' + incompatibilidades[valor].join(', ');
            }
            return '';
        }

// Funci√≥n para formatear lista de incompatibles con "y" / "e"
function formatearListaIncompatibles(lista) {
    if (!lista || lista.length === 0) return '';
    if (lista.length === 1) return lista[0];

    const ultimo = lista.pop();
    // Usar "e" si la siguiente palabra empieza por 'i' o 'I'
    const conjuncion = /^[iI]/.test(ultimo) ? 'e' : 'y';
    return lista.join(', ') + ' ' + conjuncion + ' ' + ultimo;
}

// Obtener raz√≥n por la cual una opci√≥n est√° deshabilitada (MEJORADA)
function getRazonDeshabilitada($option, rasgosActuales, puntosDisponibles) {
    const valor = $option.val();
    const tipo = $option.data('tipo');
    const puntos = parseInt($option.data('puntos'));
    let razones = [];
    let incompatibles = [];

    // Verificar puntos insuficientes (solo para virtudes)
    if (tipo === 'virtud' && puntosDisponibles < Math.abs(puntos)) {
        razones.push('‚ùå Necesitas ' + Math.abs(puntos) + ' ranuras (disponibles: ' + puntosDisponibles + ')');
    }

    // Incompatibilidades definidas en el propio rasgo
    if (incompatibilidades[valor]) {
        const incompatiblesEncontrados = rasgosActuales.filter(r =>
            incompatibilidades[valor].includes(r.valor)
        ).map(r => r.valor);
        incompatibles.push(...incompatiblesEncontrados);
    }

    // Incompatibilidades donde otros rasgos hacen incompatible a este
    rasgosActuales.forEach(r => {
        if (incompatibilidades[r.valor] && incompatibilidades[r.valor].includes(valor)) {
            incompatibles.push(r.valor);
        }
    });

    incompatibles = [...new Set(incompatibles)]; // eliminar duplicados

    if (incompatibles.length > 0) {
        const copia = [...incompatibles];
        razones.push('‚õî Incompatible con: ' + formatearListaIncompatibles(copia));
    }

    return razones.join(' | ');
}

        // Inicializar tooltips para opciones deshabilitadas (mejorado)
function inicializarTooltips() {
    // Destruir tooltips existentes para evitar duplicados
    $('.chosen-results li').each(function() {
        if (this._tippy) this._tippy.destroy();
    });

    // Esperar un instante a que el DOM del dropdown est√© listo
    setTimeout(() => {
        $('.chosen-results li.disabled-result').each(function() {
            const $li = $(this);
            const index = $li.data('option-array-index');
            if (index === undefined) return;

            // Obtener la opci√≥n real del select usando el √≠ndice
            const $select = $('select[name="rasgos"]');
            const $option = $select.find('option').eq(index);
            if (!$option.length) return;

            const razon = getRazonDeshabilitada($option, rasgosSeleccionados, puntosDisponibles);
            if (razon) {
                tippy(this, {
                    content: razon,
                    theme: 'principal',
                    placement: 'right-end',
                    arrow: false,
                    duration: 0,
                    followCursor: 'default',
                    animation: 'scale',
                    // Asegurar que el tooltip se muestre incluso si el elemento est√° dentro de un contenedor con overflow
                    appendTo: document.body
                });
            }
        });
    }, 100);
}

        // Verificar incompatibilidades
        function esCompatible(rasgoAComprobar, rasgosActuales) {
            // Si el rasgo tiene incompatibilidades definidas
            if (incompatibilidades[rasgoAComprobar.valor]) {
                for (let incompatible of incompatibilidades[rasgoAComprobar.valor]) {
                    if (rasgosActuales.some(r => r.valor === incompatible)) {
                        return false;
                    }
                }
            }
            
            // Verificar si alg√∫n rasgo actual es incompatible con el nuevo
            for (let rasgoActual of rasgosActuales) {
                if (incompatibilidades[rasgoActual.valor] && 
                    incompatibilidades[rasgoActual.valor].includes(rasgoAComprobar.valor)) {
                    return false;
                }
            }
            
            return true;
        }

        // Actualizar estado de opciones en Chosen
function actualizarOpcionesDeshabilitadas() {
    const $select = $('select[name="rasgos"]');
    const selectedValues = $select.val() || [];
    
    // Recolectar rasgos seleccionados
    rasgosSeleccionados = [];
    selectedValues.forEach(val => {
        const option = $select.find(`option[value="${val}"]`);
        rasgosSeleccionados.push({
            valor: val,
            tipo: option.data('tipo'),
            puntos: option.data('puntos')
        });
    });
    
    // Actualizar c√≠rculos de puntos
    actualizarPuntosCirculos();
    
    // Deshabilitar opciones
    $select.find('option').each(function() {
        const $option = $(this);
        if ($option.val() && !selectedValues.includes($option.val())) {
            const puntos = parseInt($option.data('puntos'));
            const tipo = $option.data('tipo');
            
            let puntosSuficientes = true;
            if (tipo === 'virtud') {
                puntosSuficientes = puntosDisponibles >= Math.abs(puntos);
            }
            
            const compatible = esCompatible({
                valor: $option.val(),
                tipo: tipo,
                puntos: puntos
            }, rasgosSeleccionados);
            
            if (!puntosSuficientes || !compatible) {
                $option.attr('disabled', 'disabled');
            } else {
                $option.removeAttr('disabled');
            }
        } else {
            $option.removeAttr('disabled');
        }
    });
    
    // Actualizar Chosen
    $select.trigger('chosen:updated');
    
    // Refrescar tooltips despu√©s de que Chosen haya actualizado el DOM
    setTimeout(inicializarTooltips, 150);
}

        // Inicializar
        $(document).ready(function() {
            // Inicializar Chosen para rasgos
            $('.multipleChosen:not(.combate-chosen)').chosen({
                placeholder_text_multiple: "Selecciona virtudes y defectos...",
                width: "100%",
                disable_search_threshold: 10,
                display_disabled_options: true
            }).on('change', function(evt, params) {
                actualizarOpcionesDeshabilitadas();
                aplicarColoresAChosen();
                
                // Verificar si se seleccion√≥ Ciego para deshabilitar combate
                const selectedValues = $(this).val() || [];
                if (selectedValues.includes('Ciego')) {
                    $('.combate-chosen').val([]).trigger('chosen:updated');
                    $('#combateError').css('display', 'flex');
                    $('#combateErrorText').text('Los personajes ciegos no pueden tener estilos de combate.');
                }
            });

            // Inicializar Chosen para estilos de combate con control de m√°ximo 2
            $('.combate-chosen').chosen({
                placeholder_text_multiple: "Selecciona hasta 2 estilos...",
                width: "100%",
                max_selected_options: 2,
                disable_search_threshold: 10
            }).on('change', function(evt, params) {
                const selectedCount = $(this).val() ? $(this).val().length : 0;
                const errorDiv = document.getElementById('combateError');
                const errorText = document.getElementById('combateErrorText');
                
                // Verificar si el personaje es ciego
                const rasgosSelect = $('select[name="rasgos"]');
                const selectedRasgos = rasgosSelect.val() || [];
                
                if (selectedRasgos.includes('Ciego')) {
                    // Si es ciego, deshabilitar y vaciar selecci√≥n de combate
                    $(this).val([]).trigger('chosen:updated');
                    errorDiv.style.display = 'flex';
                    errorText.textContent = 'Los personajes ciegos no pueden tener estilos de combate.';
                } else if (selectedCount > 2) {
                    errorDiv.style.display = 'flex';
                    errorText.textContent = 'Solo puedes seleccionar un m√°ximo de 2 estilos de combate.';
                    if (params && params.deselected) {
                        $(this).val([params.deselected]).trigger('chosen:updated');
                    }
                } else {
                    errorDiv.style.display = 'none';
                }
            });

            // Actualizar cuando se selecciona Ciego
            $('select[name="rasgos"]').on('change', function() {
                const selectedRasgos = $(this).val() || [];
                const combateSelect = $('.combate-chosen');
                const errorDiv = document.getElementById('combateError');
                const errorText = document.getElementById('combateErrorText');
                const tieneCiego = selectedRasgos.includes('Ciego');
                
                if (tieneCiego) {
                    combateSelect.val([]).trigger('chosen:updated');
                    errorDiv.style.display = 'flex';
                    errorText.innerHTML = '‚õî Los personajes ciegos no pueden tener estilos de combate.';
                    combateSelect.find('option').prop('disabled', true);
                } else {
                    combateSelect.find('option').prop('disabled', false);
                    if (!combateSelect.val() || combateSelect.val().length === 0) {
                        errorDiv.style.display = 'none';
                    }
                }
                combateSelect.trigger('chosen:updated');
            });

            // Validar bidireccionalidad: si intentan agregar Ciego teniendo combate seleccionado
            this.addEventListener('combateChange', function() {
                const rasgosSelect = $('select[name="rasgos"]');
                const combateSelect = $('.combate-chosen');
                if (rasgosSelect.val().includes('Ciego') && combateSelect.val() && combateSelect.val().length > 0) {
                    combateSelect.val([]).trigger('chosen:updated');
                }
            });

            // Aplicar colores a virtudes/defectos
            function aplicarColoresAChosen() {
                $('.chosen-choices li.search-choice').each(function() {
                    if ($(this).closest('.chosen-container').prev('select').attr('name') === 'rasgos') {
                        const texto = $(this).find('span').text();
                        const opcion = $('select[name="rasgos"] option').filter(function() {
                            return $(this).text().includes(texto);
                        }).first();
                        
                        const tipo = opcion.data('tipo');
                        if (tipo === 'virtud') {
                            $(this).addClass('virtud-choice');
                        } else if (tipo === 'defecto') {
                            $(this).addClass('defecto-choice');
                        }
                    }
                });
            }

            // Inicializar c√≠rculos
            actualizarPuntosCirculos();
            
            // Cerrar modal con Escape
            $(document).keydown(function(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                }
            });

            // Inicializar tooltips para el icono de informaci√≥n
            tippy('.puntos-info i', {
                content: 'Sistema de Rasgos: Comienza con 6 puntos. Los defectos dan m√°s puntos. Balance debe ser 0 o positivo.',
                theme: 'principal',
                placement: 'right-end',
                arrow: false,
                duration: 0,
                followCursor: 'default',
                animation: 'scale'
            });

            // Inicializar tooltips para opciones de combate
            tippy('.combate-chosen', {
                content: 'M√°ximo 2 estilos de combate. Si seleccionas Ciego, no puedes elegir combate.',
                theme: 'principal',
                placement: 'top',
                arrow: false,
                duration: 0,
                followCursor: 'default',
                animation: 'scale'
            });
        });

        // Funci√≥n para copiar c√≥digo (sin cambios)
        function copiarCodigo() {
            const codigo = document.getElementById('code').innerText;
            const button = document.getElementById('copyButton');
            const icon = button.querySelector('i');
            const text = button.querySelector('span');
            
            if (codigo && codigo.trim() !== '') {
                navigator.clipboard.writeText(codigo).then(() => {
                    button.classList.add('copied');
                    icon.className = 'fa-regular fa-check-circle';
                    text.textContent = 'C√≥digo copiado al portapapeles';
                    
                    setTimeout(() => {
                        button.classList.remove('copied');
                        icon.className = 'fa-regular fa-copy';
                        text.textContent = 'Copiar C√≥digo';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('Error al copiar: ', err);
                    const textarea = document.createElement('textarea');
                    textarea.value = codigo;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    button.classList.add('copied');
                    icon.className = 'fa-regular fa-check-circle';
                    text.textContent = '¬°Copiado!';
                    
                    setTimeout(() => {
                        button.classList.remove('copied');
                        icon.className = 'fa-regular fa-copy';
                        text.textContent = 'Copiar C√≥digo';
                    }, 2000);
                });
            }
        }

        // Funci√≥n para obtener estilos de combate del Chosen (sin cambios)
        function getEstilosCombate() {
            const select = document.querySelector('select[name="estilo_combate"]');
            if (select) {
                return Array.from(select.selectedOptions).map(opt => opt.value);
            }
            return [];
        }

        // Funci√≥n para calcular atributos con modificadores de rasgos (sin cambios)
        function calcularAtributosConRasgos(base, atributo) {
            let valor = base;
            
            rasgosSeleccionados.forEach(rasgo => {
                switch(rasgo.valor) {
                    case 'Gordo':
                        if (atributo === 'vel') valor *= 0.8;
                        break;
                    case 'Endeble':
                        if (atributo === 'fue') valor *= 0.8;
                        break;
                    case 'Manco':
                        if (atributo === 'fue') valor *= 0.6;
                        break;
                    case 'Cojo':
                        if (atributo === 'vel') valor *= 0.6;
                        break;
                    case 'Marcado':
                        if (atributo === 'vit') valor *= 0.9;
                        break;
                    case 'Enano':
                        if (atributo === 'fue') valor *= 0.75;
                        if (atributo === 'vit' || atributo === 'vel') valor *= 0.8;
                        break;
                    case 'Corpulento':
                        if (atributo === 'vit') valor *= 1.1;
                        break;
                }
            });
            
            return Math.round(valor);
        }

        // Funci√≥n principal de generaci√≥n (sin cambios)
        function generar() {
            try {
                // Obtener valores del formulario
                var img = document.querySelector('input[name="img"]')?.value || 'https://dummyimage.com/260x300/808080/111.png';
                var ooc = document.querySelector('input[name="occ"]')?.value || 'Nombre de usuario en Hobba';
                var ic = document.querySelector('input[name="ic"]')?.value || 'Nombre Apellido';
                var edad = document.querySelector('input[name="edad"]')?.value || 'Edad del personaje';
                var genero = document.querySelector('input[name="genero"]')?.value || 'G√©nero del personaje';
                var origen = document.querySelector('input[name="origen"]')?.value || 'Origen del personaje';
                var oficio = document.querySelector('input[name="oficio"]')?.value || 'Ocupaci√≥n del personaje';
                var estadocivil = document.querySelector('input[name="estadocivil"]')?.value || 'Estado civil del personaje';
                var afi = document.querySelector('input[name="afi"]')?.value || 'Casa/Facci√≥n a la que pertenece';
                var lema = document.querySelector('input[name="lema"]')?.value ? '"' + document.querySelector('input[name="lema"]').value + '"' : '"Lema de la facci√≥n, cita de batalla o t√≠tulo honor√≠fico del personaje."';
                
                var ascendencia = document.querySelector('select[name="ascendencia"]')?.value || 'Ascendencia';
                var religion = document.querySelector('select[name="religion"]')?.value || 'Religi√≥n';
                var constitucion = document.querySelector('select[name="constitucion"]')?.value || 'Atl√©tico';
                var ubicacion = document.querySelector('input[name="ubicacion"]')?.value || '¬øEn qu√© regi√≥n reside el personaje?';
                var asentamiento = document.querySelector('input[name="asentamiento"]')?.value || 'Asentamiento';
                var region = document.querySelector('input[name="region"]')?.value || 'Regi√≥n';
                var orientacion = document.querySelector('input[name="orientacion"]')?.value || 'Sexualidad del personaje';
                var estilosCombate = getEstilosCombate();

                // Calcular atributos base con constituci√≥n
                const mult = multiplicadores[constitucion] || multiplicadores['Atl√©tico'];
                let vitFinal = Math.round(BASE_VIT * mult.vit);
                let enFinal = Math.round(BASE_EN * mult.en);
                let fueFinal = Math.round(BASE_FUE * mult.fue);
                let velFinal = Math.round(BASE_VEL * mult.vel);

                // Aplicar modificadores de rasgos
                vitFinal = calcularAtributosConRasgos(vitFinal, 'vit');
                enFinal = calcularAtributosConRasgos(enFinal, 'en');
                fueFinal = calcularAtributosConRasgos(fueFinal, 'fue');
                velFinal = calcularAtributosConRasgos(velFinal, 'vel');

                // Calcular atributos sociales
                let carisma = 0;
                let persuasion = 0;
                let sabiduria = 0;
                let liderazgo = 0;

                rasgosSeleccionados.forEach(rasgo => {
                    switch(rasgo.valor) {
                        case 'Bello':
                            carisma += 2;
                            persuasion += 1;
                            break;
                        case 'Bondadoso':
                            carisma += 2;
                            break;
                        case 'Honorable':
                            carisma += 2;
                            break;
                        case 'Astuto':
                            persuasion += 2;
                            sabiduria += 1;
                            break;
                        case 'L√≠der':
                            liderazgo += 1;
                            break;
                        case 'Seductor':
                            persuasion += 3;
                            break;
                        case 'Intrigante':
                            persuasion += 4;
                            break;
                        case 'Inteligente':
                            sabiduria += 2;
                            break;
                        case 'Protector':
                            liderazgo += 1;
                            break;
                        case 'Sabio':
                            sabiduria += 4;
                            break;
                        case 'Diplom√°tico':
                            carisma += 4;
                            break;
                        case 'Feo':
                            carisma -= 2;
                            persuasion -= 2;
                            break;
                        case 'Ap√°tico':
                            carisma -= 2;
                            break;
                        case 'Atormentado':
                            carisma -= 2;
                            break;
                        case 'Tonto':
                            sabiduria -= 4;
                            break;
                    }
                });

                // Obtener rasgos seleccionados para el HTML
                function getSelectedOptions(category) {
                    var select = document.querySelector('select[name="rasgos"]');
                    var selectedOptions = [];
                    
                    if (select) {
                        var options = select.options;
                        for (var i = 0; i < options.length; i++) {
                            var optionCategory = options[i].parentNode.label;
                            if (options[i].selected && optionCategory === category) {
                                selectedOptions.push(options[i].value);
                            }
                        }
                    }
                    return selectedOptions;
                }

                var virtudes = getSelectedOptions('Virtudes');
                var defectos = getSelectedOptions('Defectos');
                
                var virtudesHTML = virtudes.map(v => '<strong class="virtud">' + v + '</strong>').join('<br>\n');
                var defectosHTML = defectos.map(d => '<strong class="defecto">' + d + '</strong>').join('<br>\n');
                var estilosCombateTexto = estilosCombate.length > 0 ? estilosCombate.join(' / ') : 'Estilo de combate del personaje';

                // Si es ciego, forzar mensaje de "No puede tener estilos de combate"
                if (rasgosSeleccionados.some(r => r.valor === 'Ciego')) {
                    estilosCombateTexto = 'No puede tener estilos de combate (Ciego)';
                }

                // Fecha
                var fechaActual = new Date();
                var dia = fechaActual.getDate();
                var mes = fechaActual.getMonth() + 1;
                var anio = fechaActual.getFullYear();
                var fechaFormateada = (dia < 10 ? '0' : '') + dia + '/' + (mes < 10 ? '0' : '') + mes + '/' + anio;

                // Construir c√≥digo HTML
                var codigoHTML = '<div class="personaje-ficha">\n';
                codigoHTML += '<div class="ficha-header">\n';
                codigoHTML += '<div class="ficha-sidebar">\n';
                codigoHTML += '<div class="ficha-imagen-contenedor">[IMG=png]' + img + '[/IMG]</div>\n';
                codigoHTML += '<div class="ficha-faccion">\n';
                codigoHTML += '<div class="texto-faccion">' + afi + '</div>\n';
                codigoHTML += '<div class="texto-ubicacion">' + asentamiento + ' ‚Ä¢ ' + region + '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="ficha-header-content">\n';
                codigoHTML += '<h1>' + ic + '</h1>\n';
                codigoHTML += '<p>' + lema + '</p>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="ficha-info"><strong>Nombre OOC</strong> ' + ooc + '\n';
                codigoHTML += '<strong>Nombre IC</strong> ' + ic + '\n';
                codigoHTML += '<strong>Edad</strong> ' + edad + '\n';
                codigoHTML += '<strong>G√©nero</strong> ' + genero + '\n';
                codigoHTML += '<strong>Origen</strong> ' + origen + '\n';
                codigoHTML += '<strong>Ubicaci√≥n actual</strong> ' + ubicacion + '\n';
                codigoHTML += '<strong>Afiliaci√≥n</strong> ' + afi + '\n';
                codigoHTML += '<strong>Estado civil</strong> ' + estadocivil + '\n';
                codigoHTML += '<strong>Orientaci√≥n sexual</strong> ' + orientacion + '\n';
                codigoHTML += '<strong>Estilo de combate</strong> ' + estilosCombateTexto + '\n';
                codigoHTML += '<strong>Ocupaci√≥n</strong> ' + oficio + '\n';
                codigoHTML += '<strong>Experiencia</strong> [color=green]<b>000</b>[/color] / [color=red]<b>000</b>[/color] / [color=gray]<b>000</b>[/color]\n';
                codigoHTML += '<strong>Dragones de Oro</strong> [color=gold]<b>250</b>[/color]</div>\n';
                codigoHTML += '<div class="ficha-atributos">\n';
                codigoHTML += '<h3>Atributos f√≠sicos</h3>\n';
                codigoHTML += '<div class="atributos-grid">\n';
                codigoHTML += '<div class="atributo-modulo"><span>Vitalidad</span>' + vitFinal + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Energ√≠a</span>' + enFinal + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Fuerza</span>' + fueFinal + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Velocidad</span>' + velFinal + '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="ficha-atributos">\n';
                codigoHTML += '<h3>Atributos sociales</h3>\n';
                codigoHTML += '<div class="atributos-grid">\n';
                codigoHTML += '<div class="atributo-modulo"><span>Carisma</span>' + carisma + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Persuasi√≥n</span>' + persuasion + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Sabidur√≠a</span>' + sabiduria + '</div>\n';
                codigoHTML += '<div class="atributo-modulo"><span>Liderazgo</span>' + liderazgo + '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="ficha-textos">\n';
                codigoHTML += '<div class="textos-seccion">\n';
                codigoHTML += '<h1>Rasgos</h1>\n';
                
                if (ascendencia && ascendencia !== 'Ascendencia') {
                    codigoHTML += '<strong>' + ascendencia + '</strong><br>\n';
                }
                if (religion && religion !== 'Religi√≥n') {
                    codigoHTML += '<strong>' + religion + '</strong><br>\n';
                }
                if (constitucion && constitucion !== 'Atl√©tico') {
                    codigoHTML += '<strong>' + constitucion + '</strong><br>\n';
                }
                
                codigoHTML += virtudesHTML;
                if (virtudesHTML && defectosHTML) {
                    codigoHTML += '<br>\n';
                }
                codigoHTML += defectosHTML;
                
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="textos-seccion">\n';
                codigoHTML += '<h1>Habilidades</h1>\n';
                codigoHTML += '<strong>Atacar</strong><br>\n';
                codigoHTML += '<strong>Evadir</strong><br>\n';
                codigoHTML += '<strong>Retirada</strong><br>\n';
                codigoHTML += '<strong>¬°Auxilio!</strong><br>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="textos-seccion">\n';
                codigoHTML += '<h1>Pertenencias</h1>\n';
                codigoHTML += '<div class="pertenencias-container"><div class="pertenencias-lista"><h2>Equipado</h2>‚àí\n';
                codigoHTML += '‚àí\n';
                codigoHTML += '‚àí</div><div class="pertenencias-lista"><h2>Inventario</h2>‚àí\n';
                codigoHTML += '‚àí\n';
                codigoHTML += '‚àí</div></div></div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '<div class="ficha-historial">\n';
                codigoHTML += '<h1>Historial de Acciones</h1>\n';
                codigoHTML += '<div class="historial-container"><div class="historial-lista">\n';
                codigoHTML += '<div class="historial-item">\n';
                codigoHTML += '<div class="historial-fecha">' + fechaFormateada + '</div>Inicio en <b>ToWHRPG</b>.\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div>\n';
                codigoHTML += '</div></div>';

                // Escapar HTML
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                document.getElementById("code").innerHTML = escapeHtml(codigoHTML);
            } catch (error) {
                console.error('Error al generar el c√≥digo:', error);
                document.getElementById("code").innerHTML = 'Error al generar el c√≥digo. Por favor, intenta de nuevo.';
            }
        }

        // Funci√≥n para actualizar atributos
        function actualizarAtributos() {
            // Solo para consola, no necesario para UI
        }
    </script>
</body>
</html>
